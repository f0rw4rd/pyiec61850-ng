name: Build and Release pyiec61850 Wheel

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_pypi:
        description: 'Publish to PyPI'
        required: false
        type: boolean
        default: false

# Minimum workflow-level permissions; jobs override as needed
permissions:
  contents: read

env:
  # Known-good commit SHA for libiec61850 v1.6.0
  LIBIEC61850_PINNED_SHA: '519b0208cc79d1af09d5ca40fb9ad1fd93822e93'
  # SHA256 of mbedTLS v3.6.0 source tarball
  MBEDTLS_SHA256: '32c500e73ee878e193e7d66bf5e4c34fb42bb968a6c9f9488aa466b16f6f3bff'

jobs:
  build-wheel:
    name: Build universal wheel
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Get libiec61850 and package versions
        id: get_version
        run: |
          LIBIEC61850_VERSION=$(python version.py --libiec61850)
          PACKAGE_VERSION=$(python version.py)

          # Sanitize: only allow alphanumeric, dots, dashes, underscores, 'v' prefix
          if ! echo "${LIBIEC61850_VERSION}" | grep -qE '^v?[a-zA-Z0-9._-]+$'; then
            echo "::error::Invalid libiec61850 version: contains disallowed characters"
            exit 1
          fi

          echo "libiec61850_version=${LIBIEC61850_VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Building libiec61850 ${LIBIEC61850_VERSION} as package version ${PACKAGE_VERSION}"

      - name: Build universal wheel in Docker
        run: |
          docker build \
            -f Dockerfile \
            --build-arg LIBIEC61850_VERSION=${{ steps.get_version.outputs.libiec61850_version }} \
            --build-arg LIBIEC61850_PINNED_SHA=${{ env.LIBIEC61850_PINNED_SHA }} \
            --build-arg MBEDTLS_SHA256=${{ env.MBEDTLS_SHA256 }} \
            --build-arg PACKAGE_VERSION=${{ steps.get_version.outputs.package_version }} \
            -t pyiec61850-build .

      - name: Extract and verify wheel
        run: |
          mkdir -p ./dist
          docker create --name whl-extract pyiec61850-build
          docker cp whl-extract:/wheels/. ./dist/
          docker rm whl-extract

          # Verify checksums
          cd ./dist && sha256sum -c SHA256SUMS && rm SHA256SUMS
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: wheel-universal
          path: ./dist/*.whl

  test-wheel:
    name: Test wheel (Python ${{ matrix.python-version }})
    needs: [build-wheel]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: wheel-universal
          path: ./dist

      - name: Install and test
        run: |
          pip install ./dist/*.whl pytest pytest-timeout
          # Copy test to /tmp to avoid local pyiec61850/ shadowing the installed wheel
          cp tests/test_import.py /tmp/test_import.py
          cd /tmp
          python -c "import pyiec61850.pyiec61850; print('SWIG bindings OK')"
          pytest /tmp/test_import.py -v --timeout=60

  create-release:
    name: Create GitHub Release
    needs: [build-wheel, test-wheel]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' && github.ref_type == 'tag'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Get package version
        id: get_version
        run: |
          PACKAGE_VERSION=$(python version.py)
          LIBIEC61850_VERSION=$(python version.py --libiec61850)
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "libiec61850_version=${LIBIEC61850_VERSION}" >> $GITHUB_OUTPUT

      - name: Download wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: wheel-universal
          path: dist

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_VERSION: ${{ steps.get_version.outputs.package_version }}
          LIBIEC61850_VERSION: ${{ steps.get_version.outputs.libiec61850_version }}
        run: |
          ls -la dist/
          gh release create "${{ github.ref_name }}" dist/*.whl \
            --title "pyiec61850-ng v${PACKAGE_VERSION}" \
            --notes "$(cat <<EOF
          ## pyiec61850-ng v${PACKAGE_VERSION}

          Python bindings for [libiec61850](https://github.com/mz-automation/libiec61850) ${LIBIEC61850_VERSION}.

          ### Supported Platforms
          - Linux x86_64
          - Python 3.9 - 3.14 (single universal wheel)

          ### Installation

          Install from PyPI:
          \`\`\`bash
          pip install pyiec61850-ng
          \`\`\`

          Or from GitHub Release:
          \`\`\`bash
          pip install pyiec61850-ng --find-links https://github.com/f0rw4rd/pyiec61850-ng/releases/download/${{ github.ref_name }}/
          \`\`\`
          EOF
          )"

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheel, test-wheel]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: |
      (github.event_name == 'push' && github.ref_type == 'tag') ||
      (github.event.inputs.publish_pypi == 'true')

    steps:
      - name: Download wheel
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: wheel-universal
          path: dist

      - name: Fix platform tag for PyPI
        run: |
          # Rename to manylinux for PyPI compatibility
          for whl in dist/*linux_x86_64.whl; do
            [ -f "$whl" ] || continue
            new=$(echo "$whl" | sed 's/linux_x86_64/manylinux1_x86_64/')
            mv "$whl" "$new"
            echo "Renamed: $(basename "$whl") -> $(basename "$new")"
          done
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist/
          skip-existing: true
