name: Build and Release pyiec61850 Wheel

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_pypi:
        description: 'Publish to PyPI'
        required: false
        type: boolean
        default: false

# Minimum workflow-level permissions; jobs override as needed
permissions:
  contents: read

env:
  # Known-good commit SHA for libiec61850 v1.6.1
  LIBIEC61850_PINNED_SHA: 'a13961110b8238d2d8ea577c1fb7592ba3017ad8'
  # SHA256 of mbedTLS v3.6.0 source tarball
  MBEDTLS_SHA256: '32c500e73ee878e193e7d66bf5e4c34fb42bb968a6c9f9488aa466b16f6f3bff'
  # SHA256 of Npcap SDK v1.16 (Windows builds only)
  NPCAP_SDK_SHA256: 'f0a8be7778ee3ae1b99bbbecb27a3ff0f6c111a4093f1c78c5c5a099607184db'

jobs:
  build-wheel:
    name: Build universal wheel
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Get libiec61850 and package versions
        id: get_version
        run: |
          LIBIEC61850_VERSION=$(python version.py --libiec61850)
          PACKAGE_VERSION=$(python version.py)

          # Sanitize: only allow alphanumeric, dots, dashes, underscores, 'v' prefix
          if ! echo "${LIBIEC61850_VERSION}" | grep -qE '^v?[a-zA-Z0-9._-]+$'; then
            echo "::error::Invalid libiec61850 version: contains disallowed characters"
            exit 1
          fi

          echo "libiec61850_version=${LIBIEC61850_VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Building libiec61850 ${LIBIEC61850_VERSION} as package version ${PACKAGE_VERSION}"

      - name: Build universal wheel in Docker
        run: |
          docker build \
            -f Dockerfile \
            --build-arg LIBIEC61850_VERSION=${{ steps.get_version.outputs.libiec61850_version }} \
            --build-arg LIBIEC61850_PINNED_SHA=${{ env.LIBIEC61850_PINNED_SHA }} \
            --build-arg MBEDTLS_SHA256=${{ env.MBEDTLS_SHA256 }} \
            --build-arg PACKAGE_VERSION=${{ steps.get_version.outputs.package_version }} \
            -t pyiec61850-build .

      - name: Extract and verify wheel
        run: |
          mkdir -p ./dist
          docker create --name whl-extract pyiec61850-build
          docker cp whl-extract:/wheels/. ./dist/
          docker rm whl-extract

          # Verify checksums
          cd ./dist && sha256sum -c SHA256SUMS && rm SHA256SUMS
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: wheel-universal
          path: ./dist/*.whl

  test-wheel:
    name: Test wheel (Python ${{ matrix.python-version }})
    needs: [build-wheel]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: wheel-universal
          path: ./dist

      - name: Install and test
        run: |
          pip install ./dist/*.whl pytest pytest-timeout
          # Copy test to /tmp to avoid local pyiec61850/ shadowing the installed wheel
          cp tests/test_import.py /tmp/test_import.py
          cd /tmp
          python -c "import pyiec61850.pyiec61850; print('SWIG bindings OK')"
          pytest /tmp/test_import.py -v --timeout=60

  build-windows:
    name: Build Windows wheel (Python ${{ matrix.python-version }})
    runs-on: windows-2022
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Activate MSVC developer environment
        uses: ilammy/msvc-dev-cmd@0b201ec74fa43914dc39ae48a89fd1d8cb592756  # v1.13.0

      - name: Clone libiec61850 v1.6.1
        run: |
          git clone --depth 50 --branch v1.6.1 https://github.com/mz-automation/libiec61850.git
          cd libiec61850
          $actual_sha = git rev-parse HEAD
          if ($actual_sha -ne "${{ env.LIBIEC61850_PINNED_SHA }}") {
            Write-Error "SHA mismatch! Expected ${{ env.LIBIEC61850_PINNED_SHA }}, got $actual_sha"
            exit 1
          }
          Write-Host "Verified: libiec61850 commit SHA matches pinned value"

      - name: Download and extract mbedTLS v3.6.0
        run: |
          $mbedtls_dir = "libiec61850/third_party/mbedtls"
          $tarball = "$mbedtls_dir/v3.6.0.tar.gz"

          # Download
          Invoke-WebRequest -Uri "https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/v3.6.0.tar.gz" -OutFile $tarball

          # Verify SHA256
          $hash = (Get-FileHash -Path $tarball -Algorithm SHA256).Hash.ToLower()
          if ($hash -ne "${{ env.MBEDTLS_SHA256 }}") {
            Write-Error "mbedTLS SHA256 mismatch! Expected ${{ env.MBEDTLS_SHA256 }}, got $hash"
            exit 1
          }
          Write-Host "mbedTLS checksum verified"

          # Extract
          tar -xzf $tarball -C $mbedtls_dir
          Get-ChildItem $mbedtls_dir

      - name: Replace SWIG interface with enhanced version
        shell: bash
        run: |
          # Copy our enhanced iec61850.i (NULL-safety typemaps, file download helpers)
          cp patches/iec61850.i libiec61850/pyiec61850/iec61850.i
          # Copy custom eventHandler (InformationReport for TASE.2)
          cp patches/informationReportHandler.hpp libiec61850/pyiec61850/eventHandlers/
          echo "Enhanced SWIG interface installed"

      - name: Download Npcap SDK
        run: |
          Invoke-WebRequest -Uri "https://npcap.com/dist/npcap-sdk-1.16.zip" -OutFile npcap-sdk.zip

          # Verify integrity
          $hash = (Get-FileHash -Path npcap-sdk.zip -Algorithm SHA256).Hash.ToLower()
          if ($hash -ne "${{ env.NPCAP_SDK_SHA256 }}") {
            Write-Error "Npcap SDK SHA256 mismatch! Expected ${{ env.NPCAP_SDK_SHA256 }}, got $hash"
            exit 1
          }
          Write-Host "Npcap SDK checksum verified"

          Expand-Archive -Path npcap-sdk.zip -DestinationPath npcap-sdk-temp

          # libiec61850 expects third_party/winpcap/{Include,Lib}
          $winpcapDir = "libiec61850/third_party/winpcap"
          New-Item -ItemType Directory -Force -Path "$winpcapDir/Include" | Out-Null
          New-Item -ItemType Directory -Force -Path "$winpcapDir/Lib" | Out-Null

          Copy-Item -Path "npcap-sdk-temp/Include/*" -Destination "$winpcapDir/Include/" -Recurse -Force
          # Use x64 libs (README says: replace Lib files with Lib/x64 on 64-bit)
          Copy-Item -Path "npcap-sdk-temp/Lib/x64/*" -Destination "$winpcapDir/Lib/" -Force

          Write-Host "Npcap SDK installed:"
          Get-ChildItem "$winpcapDir/Include" | ForEach-Object { Write-Host "  Include/$($_.Name)" }
          Get-ChildItem "$winpcapDir/Lib" | ForEach-Object { Write-Host "  Lib/$($_.Name)" }

      - name: Fix missing symbol for Windows
        shell: bash
        run: |
          # IedServer_ignoreClientRequests is declared without LIB61850_API in v1.6.0.
          # On MSVC, .c files are compiled as C++ (set_source_files_properties LANGUAGE CXX).
          # The header's extern "C" covers the declaration, but somehow this one symbol
          # doesn't resolve. All other IedServer_* functions (with LIB61850_API) work fine.
          # Fix: add a stub .c compiled as part of the SWIG module.
          cat > libiec61850/pyiec61850/win32_stubs.c << 'STUB'
          #include <stdbool.h>
          typedef struct sIedServer* IedServer;
          void IedServer_ignoreClientRequests(IedServer self, bool enable) {
              (void)self; (void)enable;
          }
          STUB

          # Add the stub to the SWIG module sources
          sed -i '/SOURCES iec61850.i/s|$|\n    win32_stubs.c|' \
            libiec61850/pyiec61850/CMakeLists.txt

      - name: Configure CMake
        run: |
          mkdir libiec61850/build
          cd libiec61850/build

          $python_root = Split-Path (Get-Command python).Source
          $python_exe = (Get-Command python).Source

          Write-Host "Python root: $python_root"
          Write-Host "Python executable: $python_exe"
          python --version

          # Prepend our Python to PATH so CMake finds it first.
          # Add Python libs dir to LIB so the MSVC linker finds pythonXY.lib.
          $python_libs = Join-Path $python_root "libs"
          $env:PATH = "$python_root;$env:PATH"
          $env:LIB = "$python_libs;$env:LIB"
          Write-Host "Added to LIB: $python_libs"

          # Persist for subsequent steps (each run: block is a new shell)
          "LIB=$python_libs;$env:LIB" >> $env:GITHUB_ENV

          # Delay-load wpcap.dll so iec61850.dll can be loaded without Npcap installed.
          cmake .. `
            -DBUILD_PYTHON_BINDINGS=ON `
            -DCMAKE_BUILD_TYPE=Release `
            -DPython_ROOT_DIR="$python_root" `
            -DPython_FIND_STRATEGY=LOCATION `
            -DCMAKE_SHARED_LINKER_FLAGS="/DELAYLOAD:wpcap.dll delayimp.lib" `
            -G "NMake Makefiles"

      - name: Build
        run: |
          cd libiec61850/build
          nmake

      - name: Test import
        run: |
          $pydir = "libiec61850/build/pyiec61850"

          # Find and copy the main DLL next to the .pyd so it can be loaded
          $main_dll = Get-ChildItem -Path libiec61850/build -Recurse -Filter "iec61850.dll" | Select-Object -First 1
          if ($main_dll) {
            Copy-Item $main_dll.FullName -Destination $pydir/ -ErrorAction SilentlyContinue
            Write-Host "Copied $($main_dll.Name) to $pydir"
          }

          $lib_dll = Get-ChildItem -Path libiec61850/build -Recurse -Filter "libiec61850.dll" | Select-Object -First 1
          if ($lib_dll) {
            Copy-Item $lib_dll.FullName -Destination $pydir/ -ErrorAction SilentlyContinue
            Write-Host "Copied $($lib_dll.Name) to $pydir"
          }

          Write-Host "=== Files in $pydir ==="
          Get-ChildItem $pydir -ErrorAction SilentlyContinue |
            ForEach-Object { Write-Host "$($_.Length)`t$($_.Name)" }

          Write-Host ""
          Write-Host "=== Testing Python import ==="
          $env:PYTHONPATH = "$pydir;$env:PYTHONPATH"
          python -c @"
          import sys, os
          print(f'Python {sys.version}')
          try:
              import pyiec61850
              print('SUCCESS: pyiec61850 SWIG bindings imported')
              print(f'Module file: {pyiec61850.__file__}')
          except ImportError as e:
              print(f'IMPORT ERROR: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'OTHER ERROR: {type(e).__name__}: {e}')
              sys.exit(1)
          "@

      - name: Package wheel
        run: |
          $pydir = "libiec61850/build/pyiec61850"
          $staging = "wheel-staging"
          $pkgdir = "$staging/pyiec61850"

          # Create package directory
          New-Item -ItemType Directory -Force -Path $pkgdir | Out-Null

          # Copy SWIG build outputs
          Copy-Item "$pydir/_pyiec61850.pyd" -Destination $pkgdir/
          Copy-Item "$pydir/pyiec61850.py" -Destination $pkgdir/

          # Copy DLLs the .pyd may need at runtime
          foreach ($pattern in @("iec61850.dll", "libiec61850.dll")) {
            $dll = Get-ChildItem -Path libiec61850/build -Recurse -Filter $pattern |
              Select-Object -First 1
            if ($dll) {
              Copy-Item $dll.FullName -Destination $pkgdir/
              Write-Host "Included: $($dll.Name)"
            }
          }

          # Copy pure-Python submodules from the repo
          foreach ($submod in @("mms", "tase2", "goose", "sv", "server", "_pyinstaller")) {
            $src = "pyiec61850/$submod"
            if (Test-Path $src) {
              Copy-Item $src -Destination $pkgdir/ -Recurse
              Write-Host "Included submodule: $submod"
            }
          }

          # Create __init__.py with Windows DLL loader + submodule imports
          $initContent = @'
          import os, sys, ctypes
          _package_dir = os.path.dirname(os.path.abspath(__file__))
          _dll_dir_handle = None
          if sys.platform == 'win32':
              if hasattr(os, 'add_dll_directory'):
                  _dll_dir_handle = os.add_dll_directory(_package_dir)
              os.environ['PATH'] = _package_dir + os.pathsep + os.environ.get('PATH', '')
              for _f in sorted(os.listdir(_package_dir)):
                  if _f.endswith('.dll') and 'iec61850' in _f.lower():
                      try:
                          ctypes.WinDLL(os.path.join(_package_dir, _f), winmode=0)
                          break
                      except Exception as _e:
                          print(f'Warning: Failed to load {_f}: {_e}')
          else:
              for _f in os.listdir(_package_dir):
                  if _f.startswith('libiec61850.so'):
                      try:
                          ctypes.CDLL(os.path.join(_package_dir, _f))
                          break
                      except Exception:
                          pass
          try:
              from . import tase2
          except ImportError:
              pass
          try:
              from . import mms
          except ImportError:
              pass
          try:
              from . import goose
          except ImportError:
              pass
          try:
              from . import sv
          except ImportError:
              pass
          try:
              from . import server
          except ImportError:
              pass
          __all__ = ['tase2', 'mms', 'goose', 'sv', 'server']
          '@
          Set-Content -Path "$pkgdir/__init__.py" -Value $initContent -Encoding utf8

          # Copy project metadata
          Copy-Item LICENSE -Destination $staging/
          Copy-Item NOTICE -Destination $staging/
          Copy-Item README.md -Destination $staging/

          # Create Windows-specific setup.py (package_data differs from Linux)
          $setupContent = @'
          import os
          from setuptools import setup, find_packages
          from setuptools.dist import Distribution
          version = os.environ.get('PACKAGE_VERSION', '1.6.0.9')
          long_description = ''
          if os.path.exists('README.md'):
              with open('README.md', 'r', encoding='utf-8') as fh:
                  long_description = fh.read()
          class BinaryDistribution(Distribution):
              def has_ext_modules(self):
                  return True
          setup(
              name='pyiec61850-ng',
              version=version,
              description='Python bindings for libiec61850 - IEC 61850 protocol implementation',
              long_description=long_description,
              long_description_content_type='text/markdown',
              author='f0rw4rd',
              author_email='pyiec61850@example.com',
              url='https://github.com/f0rw4rd/pyiec61850-ng',
              packages=find_packages(),
              package_data={'pyiec61850': ['*.pyd', '*.dll', '*.py']},
              entry_points={
                  'pyinstaller40': [
                      'hook-dirs = pyiec61850._pyinstaller:get_hook_dirs',
                  ],
              },
              include_package_data=True,
              classifiers=[
                  'Development Status :: 4 - Beta',
                  'Intended Audience :: Developers',
                  'Topic :: Software Development :: Libraries :: Python Modules',
                  'Topic :: System :: Networking',
                  'License :: OSI Approved :: GNU General Public License v3 (GPLv3)',
                  'Operating System :: Microsoft :: Windows',
                  'Programming Language :: Python :: 3',
                  'Programming Language :: Python :: Implementation :: CPython',
              ],
              python_requires='>=3.9',
              keywords='iec61850 mms goose iec-61850 power-systems substation-automation smart-grid scada tase2 iccp iec60870-6',
              project_urls={
                  'Bug Reports': 'https://github.com/f0rw4rd/pyiec61850-ng/issues',
                  'Source': 'https://github.com/f0rw4rd/pyiec61850-ng',
                  'Documentation': 'https://github.com/f0rw4rd/pyiec61850-ng#readme',
              },
              license='GPLv3',
              data_files=[('', ['LICENSE', 'NOTICE'])],
              distclass=BinaryDistribution,
          )
          '@
          Set-Content -Path "$staging/setup.py" -Value $setupContent -Encoding utf8

          # Get version and build wheel
          $version = python version.py
          Write-Host "Building wheel version: $version"
          pip install setuptools wheel
          Push-Location $staging
          $env:PACKAGE_VERSION = $version
          python setup.py bdist_wheel
          Pop-Location

          # Show result
          Write-Host "=== Built wheel ==="
          Get-ChildItem "$staging/dist/*.whl" | ForEach-Object {
            Write-Host "$($_.Length)`t$($_.Name)"
            python -c "import zipfile,sys;[print(f'  {f.filename}') for f in zipfile.ZipFile(sys.argv[1]).filelist]" $_.FullName
          }

      - name: Test wheel install
        run: |
          python -m venv test-venv
          $wheel = (Get-ChildItem "wheel-staging/dist/*.whl")[0]
          Write-Host "Installing: $($wheel.Name)"

          & test-venv/Scripts/pip.exe install $wheel.FullName

          # Run import test from a temp directory to avoid the repo's pyiec61850/
          # directory shadowing the installed wheel (CWD is on sys.path).
          $venvPython = (Resolve-Path "test-venv/Scripts/python.exe").Path
          Push-Location $env:TEMP
          Write-Host "=== Testing import from installed wheel ==="
          & $venvPython -c @'
          import pyiec61850
          print(f'Package dir: {pyiec61850._package_dir}')
          from pyiec61850 import pyiec61850 as swig_mod
          print(f'SWIG module: {swig_mod.__file__}')
          from pyiec61850 import tase2
          print(f'tase2 version: {tase2.__version__}')
          from pyiec61850 import mms
          print(f'mms version: {mms.__version__}')
          from pyiec61850 import goose
          print(f'goose version: {goose.__version__}')
          from pyiec61850 import sv
          print(f'sv version: {sv.__version__}')
          from pyiec61850 import server
          print(f'server version: {server.__version__}')
          print('SUCCESS: Wheel import works')
          '@
          Pop-Location

      - name: Upload wheel
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: wheel-windows-${{ matrix.python-version }}
          path: wheel-staging/dist/*.whl

  test-windows:
    name: Test Windows wheel (Python ${{ matrix.python-version }})
    needs: [build-windows]
    runs-on: windows-2022
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download wheel
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: wheel-windows-${{ matrix.python-version }}
          path: ./dist

      - name: Install and test
        run: |
          python -m venv test-venv
          $wheel = (Get-ChildItem "dist/*.whl")[0]
          Write-Host "Installing: $($wheel.Name)"

          & test-venv/Scripts/pip.exe install $wheel.FullName pytest pytest-timeout

          # Run import test from temp directory to avoid CWD shadowing
          $venvPython = (Resolve-Path "test-venv/Scripts/python.exe").Path
          Push-Location $env:TEMP
          Write-Host "=== Testing import ==="
          & $venvPython -c @'
          import pyiec61850
          print(f'Package dir: {pyiec61850._package_dir}')
          from pyiec61850 import pyiec61850 as swig_mod
          print(f'SWIG module: {swig_mod.__file__}')
          from pyiec61850 import tase2
          print(f'tase2 version: {tase2.__version__}')
          from pyiec61850 import mms
          print(f'mms version: {mms.__version__}')
          from pyiec61850 import goose
          print(f'goose version: {goose.__version__}')
          from pyiec61850 import sv
          print(f'sv version: {sv.__version__}')
          from pyiec61850 import server
          print(f'server version: {server.__version__}')
          print('SUCCESS: Wheel import works')
          '@

          # Run test_import.py against the installed wheel
          Write-Host "=== Running test_import.py ==="
          Copy-Item "$env:GITHUB_WORKSPACE/tests/test_import.py" -Destination $env:TEMP/
          & $venvPython -m pytest "$env:TEMP/test_import.py" -v --timeout=60
          Pop-Location

  create-release:
    name: Create GitHub Release
    needs: [build-wheel, test-wheel, build-windows, test-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' && github.ref_type == 'tag'

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Get package version
        id: get_version
        run: |
          PACKAGE_VERSION=$(python version.py)
          LIBIEC61850_VERSION=$(python version.py --libiec61850)
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "libiec61850_version=${LIBIEC61850_VERSION}" >> $GITHUB_OUTPUT

      - name: Download all wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_VERSION: ${{ steps.get_version.outputs.package_version }}
          LIBIEC61850_VERSION: ${{ steps.get_version.outputs.libiec61850_version }}
        run: |
          ls -la dist/
          gh release create "${{ github.ref_name }}" dist/*.whl \
            --title "pyiec61850-ng v${PACKAGE_VERSION}" \
            --notes "$(cat <<EOF
          ## pyiec61850-ng v${PACKAGE_VERSION}

          Python bindings for [libiec61850](https://github.com/mz-automation/libiec61850) ${LIBIEC61850_VERSION}.

          ### Supported Platforms
          - Linux x86_64 (single universal wheel, Python 3.9-3.14)
          - Windows x86_64 (per-version wheels, Python 3.9-3.14)

          ### Installation

          Install from PyPI:
          \`\`\`bash
          pip install pyiec61850-ng
          \`\`\`

          Or from GitHub Release:
          \`\`\`bash
          pip install pyiec61850-ng --find-links https://github.com/f0rw4rd/pyiec61850-ng/releases/download/${{ github.ref_name }}/
          \`\`\`
          EOF
          )"

  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheel, test-wheel, build-windows, test-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: |
      (github.event_name == 'push' && github.ref_type == 'tag') ||
      (github.event.inputs.publish_pypi == 'true')

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: Fix platform tag for PyPI
        run: |
          # Rename to manylinux for PyPI compatibility (Linux wheel only)
          for whl in dist/*linux_x86_64.whl; do
            [ -f "$whl" ] || continue
            new=$(echo "$whl" | sed 's/linux_x86_64/manylinux1_x86_64/')
            mv "$whl" "$new"
            echo "Renamed: $(basename "$whl") -> $(basename "$new")"
          done
          # Windows win_amd64 wheels are already PyPI-compatible
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist/
          skip-existing: true
